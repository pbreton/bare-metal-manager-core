# Using Both gRPC and Web UI

Carbide-api is now configured with **TLS mode** to support both gRPC clients and web browser access simultaneously.

## Configuration

```toml
listen_mode = "tls"
```

This enables:
✅ **HTTP/2** (required for gRPC)  
✅ **HTTPS** (works with web browsers)  
✅ **Both work on the same port** (1079)

## Web UI Access

### URL
**https://localhost:1079/admin**

### Browser Certificate Warning
You'll see a security warning because we're using a self-signed certificate for local development. This is **expected and safe** for local use.

**To proceed:**
- **Chrome/Edge**: Click "Advanced" → "Proceed to localhost (unsafe)"
- **Firefox**: Click "Advanced" → "Accept the Risk and Continue"
- **Safari**: Click "Show Details" → "visit this website"

## gRPC Access

### Using grpcurl

```bash
# List services (use -insecure for self-signed cert)
grpcurl -insecure localhost:1079 list

# Describe a service
grpcurl -insecure localhost:1079 describe forge.Forge

# Make a call (example)
grpcurl -insecure localhost:1079 forge.Forge/GetDomain
```

### Using gRPC Client Libraries

When connecting from code, you'll need to:

**Python example:**
```python
import grpc
from your_proto import forge_pb2, forge_pb2_grpc

# Create insecure credentials for self-signed cert
credentials = grpc.ssl_channel_credentials()
channel = grpc.secure_channel(
    'localhost:1079',
    credentials,
    options=[('grpc.ssl_target_name_override', 'localhost')]
)

# Or use insecure channel for local dev
channel = grpc.insecure_channel('localhost:1079')
```

**Go example:**
```go
import (
    "google.golang.org/grpc"
    "google.golang.org/grpc/credentials/insecure"
)

// For local development with self-signed cert
conn, err := grpc.Dial("localhost:1079", 
    grpc.WithTransportCredentials(insecure.NewCredentials()))
```

## Why TLS Mode?

### Previous Configurations

1. **`listen_mode = "plaintext_http2"`**
   - ✅ gRPC works (HTTP/2)
   - ❌ Browsers don't work (ERR_INVALID_HTTP_RESPONSE)

2. **`listen_mode = "plaintext_http1"`**
   - ✅ Browsers work (HTTP/1.1)
   - ❌ gRPC doesn't work reliably (needs HTTP/2)

3. **`listen_mode = "tls"`** ← Current
   - ✅ gRPC works (HTTP/2 with TLS)
   - ✅ Browsers work (HTTPS)
   - ⚠️ Requires accepting self-signed certificate

## Certificate Details

The self-signed certificates are located at:
```
dev/certs/localhost/localhost.crt
dev/certs/localhost/localhost.key
dev/certs/localhost/ca.crt
```

These are generated by `dev/certs/localhost/gen-certs.sh` and are valid for local development.

### Regenerating Certificates (if needed)

```bash
cd dev/certs/localhost
./gen-certs.sh
```

## Testing Both Interfaces

### Test Web UI
```bash
# Should return HTML (use -k to skip cert validation)
curl -k https://localhost:1079/admin/

# With basic auth (if prompted)
curl -k -u admin:Welcome123 https://localhost:1079/admin/
```

### Test gRPC
```bash
# Should list available services
grpcurl -insecure localhost:1079 list

# Should show forge.Forge service
grpcurl -insecure localhost:1079 describe forge.Forge
```

## Production Considerations

For production deployments:
- Replace self-signed certificates with properly signed certificates from a CA
- Configure proper DNS names
- Enable full authentication (remove `bypass_rbac` and `permissive_mode`)
- Consider using mutual TLS (mTLS) for gRPC clients

## Troubleshooting

### "connection refused" errors
Check that carbide-api is running:
```bash
lsof -i :1079
```

### gRPC calls fail with SSL errors
Make sure to use `-insecure` flag with grpcurl:
```bash
grpcurl -insecure localhost:1079 list
```

### Browser shows "connection not private"
This is expected with self-signed certificates. Click through the warning to proceed.

### Want to avoid certificate warnings?
You can add the CA certificate to your system's trust store, but this is optional for local development:
```bash
# macOS
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain dev/certs/localhost/ca.crt

# To remove later:
sudo security delete-certificate -c "localhost"
```
