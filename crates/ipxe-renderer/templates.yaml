# iPXE Script Templates
# These templates are loaded at compile time into DefaultIpxeOsRenderer

templates:
  - name: qcow-image
    description: Generic multi-platform template iPXE script for qcow images
    required_params:
      - image_url
    reserved_params:
      - base_url
      - console
    template: |
      #!ipxe

      # 1. Discover running architecture:
      iseq ${buildarch} x86_64 && set arch amd64 && goto arch_done ||
      iseq ${buildarch} arm64 && set arch arm64 && goto arch_done ||
      set arch unknown
      :arch_done
      echo
      echo Identified architecture: ${buildarch} -> ${arch}
      # Safety check:
      iseq ${arch} unknown && echo "Unsupported architecture." && sleep 5 && exit 1 ||

      # 2. Get carbide-core-generated reserved values (base URL for local artifacts and console specific to hardware):
      set base_url {{base_url}}
      set console {{console}}

      # 3. Boot qcow-imager with parameters:
      chain ${base_url}/internal/${buildarch}/qcow-imager.efi loglevel=7 console=tty0 pci=realloc=off console=${console} image_url={{image_url}} {{extra}}
      boot

  - name: ubuntu-autoinstall
    description: Template for Ubuntu autoinstall
    required_params:
      - install_iso
    required_artifacts:
      - kernel
      - initrd
    reserved_params:
      - base_url
      - console
    template: |
      #!ipxe
      # Ubuntu autoinstall template

      set base_url {{base_url}}
      set console {{console}}

      kernel {{kernel}} ip=dhcp url={{install_iso}} autoinstall ds=nocloud-net;s=${base_url}/user-data/ console=${console}
      initrd {{initrd}}
      boot

  - name: DGX OS
    description: Template for DGX OS autoinstall
    required_params:
      - install_iso
      - force_ai
      - cloudinit-url
    required_artifacts:
      - kernel
      - initrd
    reserved_params:
      - console
    template: |
      #!ipxe

      # Get carbide-core-generated reserved values (console specific to hardware):
      set console {{console}}

      kernel {{kernel}} fsck.mode=skip autoinstall ip=dhcp url={{install_iso}} nvme-core.multipath=n nouveau.modeset=0 \
        console=tty0 console=${console} nooemconfig force-ai={{force_ai}}/forge-ai.yaml ds=nocloud-net;s={{cloudinit-url}}
      initrd {{initrd}}
      
      boot

  - name: discovery-scout-aarch64-dpu
    description: Discovery Scout for ARM DPU with initrd
    reserved_params:
      - base_url
    required_params:
      - cli_cmd
      - bfnet
      - cloudinit_url
      - machine_id
      - server_uri
    template: |
      #!ipxe
      kernel {{base_url}}/internal/aarch64/carbide.efi initrd=initrd.img console=tty0 console=ttyS0,115200 console=ttyAMA0 console=hvc0 ip=dhcp cli_cmd={{cli_cmd}} bfnet={{bfnet}} bfks={{cloudinit_url}}/user-data machine_id={{machine_id}} server_uri={{server_uri}} {{extra}} ||
      imgfetch --name initrd.img {{base_url}}/internal/aarch64/carbide.root ||
      boot ||

  - name: discovery-scout-aarch64
    description: Discovery Scout for ARM Host
    reserved_params:
      - base_url
    required_params:
      - mac
      - cli_cmd
      - machine_id
      - server_uri
    template: |
      #!ipxe
      kernel {{base_url}}/internal/aarch64/scout.efi mac={{mac}} console=tty0 console=ttyS0,115200 pci=realloc=off iommu=off cli_cmd={{cli_cmd}} machine_id={{machine_id}} server_uri={{server_uri}} {{extra}} ||
      boot ||

  - name: discovery-scout-x86_64
    description: Discovery Scout for x86_64
    reserved_params:
      - base_url
    required_params:
      - mac
      - serial_console
      - cli_cmd
      - machine_id
      - server_uri
    template: |
      #!ipxe
      kernel {{base_url}}/internal/x86_64/scout.efi mac={{mac}} console=tty0 console={{serial_console}} pci=realloc=off iommu=off cli_cmd={{cli_cmd}} machine_id={{machine_id}} server_uri={{server_uri}} {{extra}} ||
      boot ||

  - name: error-instructions
    description: Error instructions template
    required_params:
      - machine_id
      - interface_id
      - current_state
    template: |
      #!ipxe
      echo Machine ID: {{machine_id}}
      echo Interface ID: {{interface_id}}
      echo Current state: {{current_state}}
      echo Could not continue boot due to invalid state ||
      sleep 5 ||
      exit ||

  - name: exit-instructions
    description: Exit instructions template
    required_params:
      - machine_id
      - interface_id
      - current_state
    template: |
      #!ipxe
      echo Machine ID: {{machine_id}}
      echo Interface ID: {{interface_id}}
      echo Current state: {{current_state}}
      echo This state assumes an OS is provisioned and will exit into the OS in 5 seconds. To re-run iPXE instructions and OS installation, trigger a reboot request with flag rebootWithCustomIpxe/boot_with_custom_ipxe set. ||
      sleep 5 ||
      exit ||

  - name: unknown-host
    description: Unknown host template
    required_params:
      - architecture
    template: |
      #!ipxe
      echo this is an unknown {{architecture}} host, not PXE booting ||
      sleep 5 ||
      exit ||

  - name: whoami
    description: Who am I iPXE script to print machine information
    template: |
      #!ipxe
      set esc:hex 1b
      set bold ${esc:string}[1m
      set boldoff ${esc:string}[22m

      set nvgreen ${esc:string}[32m
      set white ${esc:string}[37m

      echo ${nvgreen}${bold}Machine Information:
      echo ${nvgreen}${bold}MAC...........${boldoff}${white} ${netX/mac}
      echo ${nvgreen}${bold}IP............${boldoff}${white} ${netX/ip}
      echo ${nvgreen}${bold}Gateway.......${boldoff}${white} ${netX/gateway}
      echo ${nvgreen}${bold}DNS...........${boldoff}${white} ${netX/dns}
      echo ${nvgreen}${bold}Hostname......${boldoff}${white} ${hostname}
      echo ${nvgreen}${bold}Domain........${boldoff}${white} ${domain}
      echo ${nvgreen}${bold}Next Server...${boldoff}${white} ${next-server}
      echo ${nvgreen}${bold}Architecture..${boldoff}${white} ${buildarch}
      echo ${nvgreen}${bold}Platform......${boldoff}${white} ${platform}
      echo ${nvgreen}${bold}Manufacturer..${boldoff}${white} ${manufacturer}
      echo ${nvgreen}${bold}Product.......${boldoff}${white} ${product}
      echo ${nvgreen}${bold}Serial........${boldoff}${white} ${serial}
      echo
      echo Press any key to continue...
      prompt
      exit

  - name: carbide-menu-static-ipxe
    description: Carbide Menu
    template: |
      #!ipxe
      
      set esc:hex 1b
      set bold ${esc:string}[1m
      set boldoff ${esc:string}[22m
      
      set white ${esc:string}[37m
      
      #color --rgb 0x76b900 7
      #cpair --foreground 7 --background 9 0
      
      :start
      echo ${bold}${white}Carbide${boldoff} - ${version}
      prompt --key p --timeout 4000 Hit the ${bold}p${boldoff} key to open carbide menu... && goto carbide_menu || goto carbide
      
      :whoami
      ifconf -c dhcp
      isset ${43.70} && time chain --autofree http://${next-server}:8080/api/v0/pxe/whoami?uuid=${43.70}
      goto carbide_menu
      
      :carbide
      ifconf -c dhcp
      isset ${43.70} && time chain --autofree http://${next-server}:8080/api/v0/pxe/boot?uuid=${43.70}&buildarch=${buildarch}&platform=${platform}&manufacturer=${manufacturer}&product=${product}&serial=${serial} && exit 1 || goto error_handler
      
      :carbide_menu
      menu Carbide - ${hostname}
      item carbide Boot according to Carbide workflow
      item whoami Print information about this machine
      item localboot Boot to local drive
      #item netconfig Manual network configuration
      #item vlan Manual VLAN configuration
      item retry Retry boot
      item debug iPXE Debug Shell
      item reboot Reboot System
      choose --default carbide --timeout 5000 target && goto ${target}
      prompt --key p --timeout 4000 Hit the ${bold}p${boldoff} key to open carbide menu...
      goto carbide_menu
      
      :localboot
      exit
      
      :retry
      goto start
      
      :error_handler
      prompt --key p --timeout 4000 Hit the ${bold}p${boldoff} key to continue (4 seconds timeout)...
      goto carbide_menu
      
      :debug
      echo Type "exit" to return to menu
      shell
      goto carbide_menu
      
      :reboot
      reboot
      goto start
